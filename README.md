# Catalog Contracts API

## What is this API
This API is responsible for storing the client base (tenants), the products with their current prices and units of measurement, and the products each client has subscribed to.

## How it works

The API consists of four main resources:
- Tenants: Represents the clients, where each client has a name, email, and ID. Email and ID are unique and are used to identify the client;
- Products: Represents the products, where each product has a name and an SKU, a code that identifies the product;
- ProductPrices: Represents the price of each product, as well as its free usage quota;
- Contracts: Represents the products each client has subscribed to.

## Technical Details
### Tenants
- **POST /tenants**: Creates a new client.
   - Body: 
     ```json
     {
       "name": "string",
       "email": "string"
     }
     ```

- **Patch /tenants/{tenant_id}**: Updates a client. Only the name can be updated. The email serves as the client identifier.
   - Body: 
     ```json
     {
       "name": "string"
     }
     ```

- **Delete /tenants/{tenant_id}**: Deletes a client. The system performs a logical delete, meaning the client is not removed from the database but marked as deleted.

### Products
- **POST /products**: Creates a new product. The SKU is automatically generated by the system.
   - Body: 
     ```json
     {
       "name": "string"
     }
     ```

- **Patch /products/{product_id}**: Updates a product. Only the name can be updated.
   - Body: 
     ```json
     {
       "name": "string"
     }
     ```

### ProductPrices
- **POST /product/{product_id}/prices**: Creates a new price for a product. To maintain price history tracking, the system does not allow updating a price, only creating a new one. When a new price is created, the old price is marked as inactive. A price must always be associated with a product.
   - Body: 
     ```json
     {
       "product_id": "string",
       "price": "number",
       "free_usage": "number",
       "use_unity": "string"
     }
     ```

### Contracts
- **POST /contracts**: Associates a new product with a client. The contract consists of a client and a product. The system does not allow a client to have more than one active contract for the same product
   - Body: 
     ```json
     {
       "tenant_id": "string",
       "product_id": "string"
     }
     ```

- **Delete /contracts/tenants/{tenant_id}/products/{product_id}"**: Deletes a contract. The system performs a logical delete, meaning the contract is not removed from the database but marked as deleted.

# Project Setup

This project requires the following tools to run correctly:

- **Python 3.12 or higher**
- **Docker**
- **Docker Compose**
- **Poetry**

## Prerequisites

### 1. Install Python 3.12 or Higher

This project requires Python 3.12 or higher. To facilitate the installation and management of Python versions, we recommend using `pyenv`.

#### How to Install Python 3.12 with `pyenv`:

1. **Install `pyenv`**:
   - Follow the installation instructions for `pyenv` in the [official link](https://github.com/pyenv/pyenv#installation).

2. **Install Python 3.12**:
   After installing `pyenv`, you can install Python 3.12 with the following command:
   ```bash
   pyenv install 3.12.0

3. **Set Python 3.12 as the Default Version**:
To set version 3.12 as the default, run the following command inside the project repository:
   ```bash
   pyenv local 3.12.0
   ```

### 2.  Install Docker and Docker Compose

1. **Install  `docker`**:
   - Follow the installation instructions for docker in the [official link](https://docs.docker.com/get-docker/).

2. **Install  `docker-compose`**:
    - Follow the installation instructions for `docker-compose` in th[official link](https://docs.docker.com/compose/install/).
  
### 3. Install Poetry

Poetry will be required locally to run commands like migrations without needing to run `docker-compose`, or even to run the project outside of Docker to facilitate debugging.

1. **Install `poetry`**:
   - Follow the installation instructions for `poetry` in the [official link](https://python-poetry.org/docs/#installation).
  
# Run the Project Locally
### Run the Project Locally
1. Run PostgreSQL via Docker
```bash
docker run --name postgres-magalu -e POSTGRES_PASSWORD=postgres -e POSTGRES_USER=postgres -e POSTGRES_DB=postgres -p 5432:5432 -d -v /var/lib/postgresql/data postgres
```
This will create a container running PostgreSQL. The default database will be postgres, with the user postgres and password postgres.

2. Copy the .env.example file to .env in the project root.
```bash
cp .env.example .env
```
3. Edit the .env file and update the environment variables for the database.
```bash
DB_ASYNC_CONNECTION_STR="postgresql+asyncpg://postgres:postgres@localhost/postgres"
DEBUG=True
```
4. Install the project dependencies.
```bash
poetry install
```
5. Run the migrations.
```bash
poetry run alembic upgrade head
```
6. Start the project.
```bash
poetry run uvicorn app.main:app --reload --workers 1 --host 0.0.0.0 --port 8000
```
You can now make requests to the API locally. The base URL is: http://localhost:8000/v1/{resource}

# Development
### Running Tests
To execute the tests, ensure the PostgreSQL container is running.
1. Running Tests
```bash
poetry run pytest -p no:warnings
```
### Creating a New Migration if Models are Changed
1. Create migration
```bash
poetry run alembic revision --autogenerate -m "Migration description"
```
1. Apply migration
```bash
poetry run alembic upgrade head
```


